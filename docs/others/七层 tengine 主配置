七层 tengine 主配置
##Start.

user  www www;
worker_processes auto;
worker_rlimit_nofile 65535;

error_log  /data1/tengine.error.log;
pid        var/logs/tengine.pid;

events {
    use epoll;
    worker_connections  65535;
    multi_accept on;
}

http {
	server_tokens off;
	server_tag WeiBo;
	log_empty_request off;
	access_log off;
	include       tengine.mime.types;
	default_type  application/octet-stream;

        log_format  main  '$http_host $remote_addr ${request_time}s $upstream_addr [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" $http_x_log_uid "SUP=$cookie_SUP" "REQUEST_ID=$request_uid" "$http_user_agent" "UID=$log_uid"  "UP_STATUS=$upstream_status" "UP_TIME=${upstream_response_time}s"';

        log_format logstash '$http_host $remote_addr [$time_local] "$request" '
                  '$status $request_time $body_bytes_sent "$http_referer" '
                  '$upstream_addr $upstream_response_time $upstream_status';

	add_header LB_HEADER $hostname;
        sendfile on;
	keepalive_timeout 0;
	lingering_timeout 50ms;

        proxy_buffering off;
        proxy_buffer_size 8k;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_http_version 1.1;
        proxy_intercept_errors on;
        proxy_next_upstream http_502 http_504 error timeout invalid_header;
        proxy_temp_path /usr/local/sinasrv2/proxy_temp;

        client_max_body_size 120m;
        client_body_buffer_size 512k;
        server_names_hash_max_size 512;
        server_names_hash_bucket_size 128;
        client_header_buffer_size 1k;
        large_client_header_buffers 8 8k;

        check_shm_size 10m;
        client_body_temp_path  /usr/local/sinasrv2/client_body_temp 1 2;

        lua_package_path "/usr/local/sinasrv2/lib/lua/?.lua;;/usr/local/sinasrv2/etc/lua/?.lua;;";
        lua_shared_dict huati_uid_zone 30m;
        init_by_lua_file /usr/local/sinasrv2/etc/lua/init.lua;

        map $http_x_proto $x_forwarded_for {
                default $remote_addr;
                "SSL" $http_x_forwarded_for;
		"HTTPV6" $http_x_forwarded_for;
        }

    	#map $http_X_BWSNPI $x_forwarded_for {
        #    default $remote_addr;
        #    ""      $remote_addr;
        #}

        map $http_user_agent $mobile {
            default 0;
            "~*Tablet" 1;
            "~*ipad" 1;
            "~*MiuiBrowser" 1;
            "~*SM-T700" 1;
            "~*SM-T705C" 1;
            "~*SM-T800" 1;
            "~*SM-T805C" 1;
            "~*Android" 3;
            "~*iPhone" 3;
            "~*iPod" 3;
            "~*OperaMini" 2;
            "~*SmartPhone" 2;
            "~*Symbian" 2;
            "~*WindowsCE" 2;
            "~*Mobile" 2;
            "~*MOT" 2;
            "~*MUAI" 2;
            "~*Motorola" 2;
            "~*Nokia" 2;
            "~*SonyEricsson" 2;
        }

        map $cookie_POLICY $backend {
            default "V5-YF-G0";
        }

        map $cookie_wvr6 $msghost {
            default "v5.weibo.com";
            "1"     "v6.weibo.com";
        }

        map $cookie_wvr6$arg_ajwvr $ajhost {
            default "v5.weibo.com";
            "16"    "v6.weibo.com";
        }

        map $geo_location $weibo_black_uid_policy_arg {
             default "G0";
        }

        geo $http_x_forwarded_for $geo_location {
                ranges;
                default UNKNOWN;
        }

	include upstream/upstreams.conf;
	include upstream/ad.yf.upstream;
	include upstream/huati.yf.upstream;
	include upstream/hot.yf.upstream;
	include upstream/ting.yf.upstream;
	include upstream/vip.yf.upstream;
	include upstream/tv.yf.upstream;
	include upstream/newvip.yf.upstream;
	include upstream/gongyi.yf.upstream;
	include upstream/v4gongyi.yf.upstream;
	include upstream/servicehuati.yf.upstream;
	include upstream/servicelive.yf.upstream;
	include upstream/newhuati.yf.upstream;
	include upstream/star.yf.upstream;
	include upstream/mcn.yf.upstream;
	include upstream/hd.yf.upstream;
	include upstream/ixhuati.yf.upstream;
	include upstream/rich.yf.upstream;
	include upstream/rc.yf.upstream;
	include upstream/camera.yf.upstream;
	include upstream/video.yf.upstream;
	include upstream/biz.yf.upstream;
	include upstream/recom.yf.upstream;
	include upstream/secsys.yf.upstream;
	include upstream/admin.yf.upstream;
	include upstream/apache.yf.upstream;
	include upstream/saccount.yf.upstream;
	include upstream/photo.yf.upstream;
	include upstream/safeit.yf.upstream;
	include upstream/igochaohua.yf.upstream;
	include  /*.conf;
}

#### End